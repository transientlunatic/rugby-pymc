name: Train Model (Weekly VI)

on:
  schedule:
    - cron: '30 20 * * 0'  # Sunday 20:30 UTC
  workflow_dispatch:
    inputs:
      training-iterations:
        description: 'VI iterations (default: 50000, matching train_model.py)'
        default: '50000'
      force-fresh-training:
        description: 'Force fresh training (skip loading checkpoints)'
        type: boolean
        default: false

jobs:
  train:
    runs-on: ubuntu-latest
    timeout-minutes: 60

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install rugby-ranking package
        run: |
          pip install --upgrade pip
          pip install scikit-learn
          pip install git+https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/transientlunatic/rugby-pymc.git

      - name: Download MCMC checkpoint from Release (if available)
        if: github.event.inputs.force-fresh-training != 'true'
        id: download-mcmc
        continue-on-error: true
        run: |
          # Try to download latest MCMC checkpoint from rugby-pymc releases
          LATEST_RELEASE=$(gh release list --repo transientlunatic/rugby-pymc --limit 1 --json tagName --jq '.[0].tagName' 2>/dev/null || echo "")

          if [ -n "$LATEST_RELEASE" ]; then
            echo "Found release: $LATEST_RELEASE"
            if gh release download "$LATEST_RELEASE" \
              --repo transientlunatic/rugby-pymc \
              --pattern 'mcmc-*.tar.gz' \
              --dir /tmp/mcmc-checkpoint 2>/dev/null; then
              echo "found=true" >> $GITHUB_OUTPUT
              echo "âœ“ Downloaded MCMC checkpoint from $LATEST_RELEASE"
            else
              echo "found=false" >> $GITHUB_OUTPUT
            fi
          else
            echo "found=false" >> $GITHUB_OUTPUT
          fi
        env:
          GH_TOKEN: ${{ github.token }}

      - name: Download previous VI checkpoint (fallback)
        if: steps.download-mcmc.outputs.found != 'true' && github.event.inputs.force-fresh-training != 'true'
        id: download-vi
        uses: dawidd6/action-download-artifact@v6
        continue-on-error: true
        with:
          workflow: train-model-weekly.yml
          name: model-checkpoint-weekly
          path: /tmp/vi-checkpoint
          if_no_artifact_found: warn

      - name: Restore checkpoint
        if: github.event.inputs.force-fresh-training != 'true'
        run: |
          # Prefer MCMC checkpoint if available
          if [ "${{ steps.download-mcmc.outputs.found }}" = "true" ] && [ -f /tmp/mcmc-checkpoint/mcmc-*.tar.gz ]; then
            echo "âœ“ Using MCMC checkpoint from Release"
            mkdir -p ~/.cache/rugby_ranking/weekly-model
            cd ~/.cache/rugby_ranking/weekly-model
            tar -xzf /tmp/mcmc-checkpoint/mcmc-*.tar.gz
          elif [ -d "/tmp/vi-checkpoint" ] && [ -f "/tmp/vi-checkpoint/checkpoint.tar.gz" ]; then
            echo "âœ“ Using previous VI checkpoint"
            mkdir -p ~/.cache/rugby_ranking/weekly-model
            cd ~/.cache/rugby_ranking/weekly-model
            tar -xzf /tmp/vi-checkpoint/checkpoint.tar.gz
          else
            echo "â„¹ No checkpoint found, will train fresh"
          fi

      - name: Train model
        run: |
          python -c "
          import sys
          from pathlib import Path
          from datetime import datetime, timedelta
          import pandas as pd
          sys.path.insert(0, str(Path.home() / '.local/lib/python3.11/site-packages'))

          from rugby_ranking.model.data import MatchDataset
          from rugby_ranking.model.core import RugbyModel, ModelConfig
          from rugby_ranking.model.inference import ModelFitter, InferenceConfig

          # Load data
          dataset = MatchDataset('json', fuzzy_match_names=False)
          dataset.load_json_files()
          df = dataset.to_dataframe(played_only=True)

          # Filter to recent years (last 3 years) but keep complete seasons
          cutoff_date = pd.Timestamp.now(tz='UTC') - timedelta(days=3*365)
          df['date'] = pd.to_datetime(df['date'], utc=True)

          # Find matches after cutoff to identify relevant seasons
          recent_matches = df[df['date'] >= cutoff_date]
          recent_seasons = recent_matches['season'].unique()

          # Include ALL matches from those seasons (don't cut seasons in half)
          df = df[df['season'].isin(recent_seasons)].copy()

          print(f'Cutoff date: {cutoff_date.date()}')
          print(f'Seasons included: {sorted(recent_seasons)}')
          print(f'Training on {len(df):,} observations')
          print(f'Date range: {df[\"date\"].min().date()} to {df[\"date\"].max().date()}')

          # Build model
          config = ModelConfig(
              include_defense=True,
              separate_kicking_effect=True,
          )
          model = RugbyModel(config)
          model.build_joint(df)

          # Configure inference (use 50k iterations as per train_model.py default)
          vi_iterations = ${{ github.event.inputs.training-iterations || 50000 }}
          inference_config = InferenceConfig(vi_n_iterations=vi_iterations)
          force_fresh = '${{ github.event.inputs.force-fresh-training }}' == 'true'

          # Try to load previous checkpoint and continue training (unless force-fresh)
          if force_fresh:
              print('ðŸ”„ Force fresh training enabled - skipping checkpoint loading')
              fitter = ModelFitter(model, inference_config)
              trace = fitter.fit_vi(n_samples=500, verbose=True)
          else:
              try:
                  fitter = ModelFitter.load('weekly-model', model)
                  print('âœ“ Loaded previous checkpoint')

                  # Continue training with warm-start
                  if fitter._vi_approx is not None:
                      print(f'âœ“ Continuing VI training with warm-start for {vi_iterations:,} additional iterations')
                      # Update the inference config for continued training
                      fitter.config = inference_config
                      trace = fitter.fit_vi(
                          warm_start=True,
                          n_samples=500,
                          verbose=True,
                      )
                  else:
                      print(f'âš  No VI approximation, training fresh for {vi_iterations:,} iterations')
                      fitter = ModelFitter(model, inference_config)
                      trace = fitter.fit_vi(n_samples=500, verbose=True)
              except (FileNotFoundError, ValueError) as e:
                  print(f'â„¹ No previous checkpoint ({e}), training fresh for {vi_iterations:,} iterations')
                  fitter = ModelFitter(model, inference_config)
                  trace = fitter.fit_vi(n_samples=500, verbose=True)

          # Save checkpoint
          fitter.save('weekly-model')
          print('âœ“ Checkpoint saved')
          "

      - name: Compress checkpoint
        run: |
          cd ~/.cache/rugby_ranking/weekly-model
          # Include vi_approx.pkl only if it exists (it may fail to pickle)
          if [ -f vi_approx.pkl ]; then
            tar -czf checkpoint.tar.gz trace.nc vi_approx.pkl metadata.pkl
          else
            echo "âš  vi_approx.pkl not found, creating checkpoint without it"
            tar -czf checkpoint.tar.gz trace.nc metadata.pkl
          fi

      - name: Upload checkpoint artifact
        uses: actions/upload-artifact@v4
        with:
          name: model-checkpoint-weekly
          path: ~/.cache/rugby_ranking/weekly-model/checkpoint.tar.gz
          retention-days: 14

      - name: Upload weekly snapshot
        if: github.event.schedule
        uses: actions/upload-artifact@v4
        with:
          name: model-checkpoint-${{ github.run_number }}
          path: ~/.cache/rugby_ranking/weekly-model/checkpoint.tar.gz
          retention-days: 90

      - name: Summary
        run: |
          echo "### Model Training Complete" >> $GITHUB_STEP_SUMMARY
          echo "âœ… VI training completed successfully" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ github.event.inputs.force-fresh-training }}" = "true" ]; then
            echo "**Starting point**: ðŸ”„ Fresh training (forced)" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ steps.download-mcmc.outputs.found }}" = "true" ]; then
            echo "**Starting point**: MCMC checkpoint from Release (warm-start)" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ steps.download-vi.outcome }}" = "success" ]; then
            echo "**Starting point**: Previous VI checkpoint (warm-start)" >> $GITHUB_STEP_SUMMARY
          else
            echo "**Starting point**: Fresh training (no checkpoint)" >> $GITHUB_STEP_SUMMARY
          fi

          echo "**VI Iterations**: ${{ github.event.inputs.training-iterations || '50000' }}" >> $GITHUB_STEP_SUMMARY
          echo "**Saved as**: weekly-model" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "_Note: Weekly training uses 50k VI iterations by default (matching train_model.py)_" >> $GITHUB_STEP_SUMMARY
